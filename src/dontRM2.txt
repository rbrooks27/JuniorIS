import os
from tqdm import tqdm
from combined123 import parse_multistep_smirks, draw_multistep_pathway  #  unified script

"""
Overview:
This script reads a dataset of chemical reactions in SMIRKS format (Reactants > Reagents > Products)
and generates visual representations of the reaction pathways using the unified parser/drawing functions.
"""

# -------------------------------
# Dataset and output settings
# -------------------------------
dataset_file = "dataset/textbookReactions.txt"  # smaller sample for testing
# dataset_file = "dataset/reactionSmilesFigShare2024.txt"  # full dataset

output_dir = "data/reactions"  # output directory for pathway images
os.makedirs(output_dir, exist_ok=True)

MAX_LINES = 10  # set to None to process all lines

# -------------------------------
# Process each SMIRKS line
# -------------------------------
with open(dataset_file, "r") as f:
    for i, line in enumerate(tqdm(f, desc="Generating pathways")):
        if MAX_LINES and i >= MAX_LINES:
            break

        line = line.strip()
        if not line:
            continue

        # Skip invalid lines
        if ">" not in line:
            print(f"Skipping invalid SMIRKS line {i}: {line}")
            continue

        try:
            # Parse the SMIRKS into steps
            steps = parse_multistep_smirks(line)

            # Skip if parsing returned nothing
            if not steps:
                print(f"No valid steps found at line {i}")
                continue

            # Generate output path
            output_path = os.path.join(output_dir, f"reaction_{i}.png")

            # Draw the multistep pathway
            draw_multistep_pathway(steps, output_path)

        except Exception as e:
            print(f"Error processing line {i}: {line}")
            print(f"Error: {e}")
            continue

print("Done generating reaction pathways!")
    